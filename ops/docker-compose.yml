version: '3.8'

services:
  # App: Codenames
  # Port 8000 on Host -> 80 in Container
  codenames:
    image: selfpraxis:codenames-${CODENAMES_TAG}
    container_name: selfpraxis-codenames
    restart: always
    ports:
      - "8000:80"
    networks:
      - selfpraxis_net

  # App: Series Bible
  # Port 8001 on Host -> 80 in Container
  series-bible:
    image: selfpraxis:series-bible-${SERIES_BIBLE_TAG}
    container_name: selfpraxis-series-bible
    restart: always
    ports:
      - "8001:80"
    networks:
      - selfpraxis_net

  # App: Shift Signups
  # Port 8002 on Host -> 80 in Container
  shift-signups:
    image: selfpraxis:shift-signups-${SHIFT_SIGNUPS_TAG}
    container_name: selfpraxis-shift-signups
    restart: always
    read_only: true # Hardening: File system is immutable
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL # Hardening: Drop all Linux capabilities
    # cap_add:
    #   - NET_BIND_SERVICE # Required if binding to port 80? (Actually, let's keep it safe. If it fails, we change port to 8080)
    # Testing note: Non-root binding to port 80 usually requires NET_BIND_SERVICE.
    cap_add:
      - NET_BIND_SERVICE
    volumes:
      - ../data/shift-signups:/app/data # Writable volume exception
      - /tmp # Temp directory often needed by Node
    ports:
      - "8002:80"
    networks:
      - selfpraxis_net

  # App: Homepage
  # Port 8003 on Host -> 80 in Container
  homepage:
    image: selfpraxis:homepage-${HOMEPAGE_TAG}
    container_name: selfpraxis-homepage
    restart: always
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    volumes:
      - /tmp # express/helmet might need temp? 
    ports:
      - "8003:80"
    networks:
      - selfpraxis_net

  # Staging Slot (Shared)
  # Port 8009 on Host -> 80 in Container
  staging:
    image: ${STAGING_IMAGE:-nginx:alpine}
    container_name: selfpraxis-staging
    restart: always
    ports:
      - "8009:80"
    networks:
      - selfpraxis_net

networks:
  selfpraxis_net:
    driver: bridge
