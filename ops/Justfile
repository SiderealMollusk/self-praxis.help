# Remote Hosts (Override these in .env)
# default: assuming you have ssh config aliases set up
set dotenv-load

nuc_host := env_var_or_default("nuc_host", "nuc")
vps_host := env_var_or_default("vps_host", "vps")

# Project Paths on Remote
nuc_root := "/srv/selfpraxis"
vps_upstream_conf := "/etc/nginx/snippets/selfpraxis-prod-upstream.conf"

set shell := ["bash", "-c"]

# Default: List commands
default:
    @just --list --unsorted

# --- Local Helpers ---

# Check which color is currently active (run from laptop, queries VPS)
# --- Status & Verification ---
# --- Status & Verification ---
active-color:
    @./scripts/dev/get-active-color.sh {{vps_host}}

verify-next:
    @echo "Verifying the Candidate (Inactive) deployment..."
    @INACTIVE=$(./scripts/dev/get-inactive-color.sh {{vps_host}}) && \
    if [ "$INACTIVE" == "green" ]; then \
        echo "Candidate: GREEN (Port 8002)"; \
        curl -I http://100.104.75.126:8002; \
    elif [ "$$INACTIVE" == "blue" ]; then \
        echo "Candidate: BLUE (Port 8000)"; \
        curl -I http://100.104.75.126:8000; \
    fi

# --- Deployment Workflows ---


# --- Secrets Management ---

# Encrypt local .env to secrets.enc.env (Global Infra)
save-secrets:
    sops --encrypt .env > secrets.enc.env

# Decrypt secrets.enc.env to local .env
load-secrets:
    sops --decrypt secrets.enc.env > .env

# --- App Deployment Workflows ---

# Deploy an App to Staging (Usage: just deploy codenames)
deploy app:
    @echo "Deploying {{app}}..."
    just _git-update
    just _push-app-config {{app}}
    just _build-and-deploy {{app}}

_push-app-config app:
    @echo "Pushing {{app}} config..."
    scp ../apps/{{app}}/.env {{nuc_host}}:{{nuc_root}}/apps/{{app}}/.env

_git-update:
    ssh -t {{nuc_host}} "cd {{nuc_root}} && git pull"

_build-and-deploy app:
    ssh -t {{nuc_host}} "cd {{nuc_root}} && \
        SHA=\$(git rev-parse --short HEAD) && \
        ./ops/scripts/prem/generate-site.sh {{app}} && \
        cp ops/docker-compose.yml docker/ && \
        docker build -t selfpraxis:{{app}}-\$SHA apps/{{app}} && \
        {{app | update_to_upper}}_TAG=\$SHA docker compose -f docker/docker-compose.yml up -d {{app}}"

# Bootstrap the Nuc (Run once)
bootstrap-nuc:
    @echo "Bootstrapping Nuc directories and repos..."
    ssh -t {{nuc_host}} "sudo mkdir -p {{nuc_root}} && sudo chown \$(whoami) {{nuc_root}} && \
    cd {{nuc_root}} && \
    ([ -d .git ] || git clone https://github.com/SiderealMollusk/self-praxis.help.git .) && \
    mkdir -p docker && echo 'Bootstrap complete!'"
