# Production Nginx Configuration for self-praxis.help
# Managed by Git in /ops/nginx/prod-selfpraxis.conf

# Upstream Definitions
# Pointers to the Nuc (Tailscale IP)
upstream app_codenames { server 100.104.75.126:8000; }
upstream app_series_bible { server 100.104.75.126:8001; }

# Dynamic Upstream for "Active/Promoted" app (Optional usage)
# include /etc/nginx/snippets/selfpraxis-prod-upstream.conf;

server {
    listen 80;
    server_name self-praxis.help www.self-praxis.help;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name self-praxis.help www.self-praxis.help;

    ssl_certificate     /etc/letsencrypt/live/self-praxis.help/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/self-praxis.help/privkey.pem;

    # --- Routing ---

    # Default / Root -> Codenames (Port 8000)
    location / {
        proxy_pass http://app_codenames;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # /codenames -> Codenames (Port 8000)
    location /codenames/ {
        proxy_pass http://app_codenames/; # Trailing slash strips path
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # /series-bible -> Series Bible (Port 8001)
    location /series-bible/ {
        proxy_pass http://app_series_bible/; # Trailing slash strips path
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
