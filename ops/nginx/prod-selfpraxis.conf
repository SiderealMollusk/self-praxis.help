# Production Nginx Configuration for unvetted.net
# Managed by Git in /ops/nginx/prod-selfpraxis.conf

# Upstream Definitions
# Pointers to the Nuc (Tailscale IP)
upstream app_codenames { server 100.104.75.126:8000; }
upstream app_series_bible { server 100.104.75.126:8001; }
upstream app_shift_signups { server 100.104.75.126:8002; }
upstream app_homepage { server 100.104.75.126:8003; }
upstream app_staging { server 100.104.75.126:8009; }

# Dynamic Upstream for "Active/Promoted" app (Optional usage)
# include /etc/nginx/snippets/selfpraxis-prod-upstream.conf;

# --- Staging Server Block ---
server {
    listen 80;
    listen 443 ssl;
    server_name staging.unvetted.net;

    ssl_certificate     /etc/letsencrypt/live/unvetted.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/unvetted.net/privkey.pem;

    location / {
        proxy_pass http://app_staging;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name unvetted.net www.unvetted.net;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name unvetted.net www.unvetted.net;

    ssl_certificate     /etc/letsencrypt/live/unvetted.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/unvetted.net/privkey.pem;

    # --- Routing ---

    # Default / Root -> Homepage (Port 8003)
    location / {
        proxy_pass http://app_homepage;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # /codenames -> Codenames (Port 8000)
    location /codenames/ {
        proxy_pass http://app_codenames/; # Trailing slash strips path
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # /series-bible -> Series Bible (Port 8001)
    location /series-bible/ {
        proxy_pass http://app_series_bible/; # Trailing slash strips path
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # /shift-signups -> Shift Signups (Port 8002)
    location /shift-signups/ {
        proxy_pass http://app_shift_signups/; # Trailing slash strips path
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
