# Production Nginx Configuration for unvetted.net
# Managed by Git in /ops/nginx/prod-selfpraxis.conf


# Security: Buffer Limits (Prevent Overflows/DOS)
client_body_buffer_size 10K;
client_header_buffer_size 1k;
client_max_body_size 1m;
large_client_header_buffers 2 1k;

# Security: Hide Nginx Version
server_tokens off;

# Security: Rate Limiting Zones
# Zone 1: General Limits (10 req/s, 10MB memory)
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=10r/s;
# Zone 2: API Limits (5 req/s, 10MB memory) - Stricter for sensitive endpoints
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=5r/s;

# Upstream Definitions
# Pointers to the Nuc (Tailscale IP)
upstream app_codenames { server 100.104.75.126:8000; }
upstream app_series_bible { server 100.104.75.126:8001; }
upstream app_shift_signups { server 100.104.75.126:8002; }
upstream app_homepage { server 100.104.75.126:8003; }
upstream app_staging { server 100.104.75.126:8009; }

# Dynamic Upstream for "Active/Promoted" app (Optional usage)
# include /etc/nginx/snippets/selfpraxis-prod-upstream.conf;

# --- Staging Server Block ---
server {
    listen 80;
    listen 443 ssl;
    server_name staging.unvetted.net;

    ssl_certificate     /etc/letsencrypt/live/unvetted.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/unvetted.net/privkey.pem;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    # hiding upstream headers
    proxy_hide_header X-Powered-By;

    location / {
        proxy_pass http://app_staging;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name unvetted.net www.unvetted.net;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name unvetted.net www.unvetted.net;

    ssl_certificate     /etc/letsencrypt/live/unvetted.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/unvetted.net/privkey.pem;

    ssl_certificate     /etc/letsencrypt/live/unvetted.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/unvetted.net/privkey.pem;

    # --- Routing ---

    # Default / Root -> Homepage (Port 8003)
    location / {
        limit_req zone=general_limit burst=20 nodelay;
        proxy_pass http://app_homepage;
        include /etc/nginx/snippets/selfpraxis-proxy.conf;
    }

    # /codenames -> Codenames (Port 8000)
    location /codenames/ {
        limit_req zone=general_limit burst=20 nodelay;
        proxy_pass http://app_codenames/; # Trailing slash strips path
        include /etc/nginx/snippets/selfpraxis-proxy.conf;
    }

    # /series-bible -> Series Bible (Port 8001)
    location /series-bible/ {
        limit_req zone=general_limit burst=20 nodelay;
        proxy_pass http://app_series_bible/; # Trailing slash strips path
        include /etc/nginx/snippets/selfpraxis-proxy.conf;
    }

    # /shift-signups -> Shift Signups (Port 8002)
    location /shift-signups/ {
        # Stricter limits for this interactive app
        limit_req zone=api_limit burst=10 nodelay; 
        proxy_pass http://app_shift_signups/; # Trailing slash strips path
        include /etc/nginx/snippets/selfpraxis-proxy.conf;
    }
}
